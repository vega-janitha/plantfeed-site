---
name: Deploy to Production (EC2)

on:
  push:
    branches:
      - test

jobs:
  deploy:
    name: Deploy on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
      
      - name: Deploy Application
        run: |
          ssh -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF

          set -e

          export PATH=$PATH:/home/ubuntu/.local/share/pnpm

          cd ${{ secrets.APP_DIR }}

          echo "Pulling latest changes from main branch..."
          git pull origin main

          echo "Installing dependencies..."
          pnpm install

          echo "Cleaning previous builds..."
          pnpm run clean

          echo "Building the application..."
          if pnpm run build; then
            echo "Build succeeded. Restarting PM2 service..."
            pm2 restart fabnest3d
          else
            echo "Build failed. Exiting deployment."
            exit 1
          fi

          echo "Deployment completed successfully."
          EOF
